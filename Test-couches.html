<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Atlas Historique du Limousin</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.css" rel="stylesheet">

    <link rel="stylesheet" crossorigin href="/style.css">
    <link rel="icon" type="image/png" href="/static/img/favicon.ico">
</head>

<body>

    <div id="map"></div>

    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <label>Opacité de la carte de l'état-major: <span id="slider-value-1">100%</span></label>
            <input id="slider1" type="range" min="0" max="100" step="0" value="100">

            <label>Opacité des orthophotos: <span id="slider-value-2">100%</span></label>
            <input id="slider2" type="range" min="0" max="100" step="0" value="100">
        </div>
    </div>

    <script>

        const map = new maplibregl.Map({
            container: 'map',
            // Choose from maplibre's core styles, or make your own style with maplibre Studio
            style:
                // 'https://data.geopf.fr/annexes/ressources/vectorTiles/styles/PLAN.IGN/standard.json',
                'https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL',
            center: [1.25866, 45.83088],
            maxBounds: [[1.14858, 45.79313], [1.36808, 45.86836]],
            minZoom: 9.5,
            maxZoom: 20,
            zoom: 9.5
        });

        const slider1 = document.getElementById('slider1');
        const sliderValue1 = document.getElementById('slider-value-1');

        const slider2 = document.getElementById('slider2');
        const sliderValue2 = document.getElementById('slider-value-2');

        map.on('load', () => {

            const layers = map.getStyle().layers;
            // Find the index of the first symbol layer in the map style
            let firstSymbolId;
            for (let i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol') {
                    firstSymbolId = layers[i].id;
                    break;
                }
            }

            map.addSource('orthophotos-2023', {
                'type': 'raster',
                'tiles': [
                    'https://data.geopf.fr/wms-r?LAYERS=ORTHOIMAGERY.ORTHOPHOTOS.ORTHO-EXPRESS.2023&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'
                    // 'https://data.geopf.fr/wms-r?LAYERS=ORTHOIMAGERY.ORTHOPHOTOS.1950-1965&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'
                    // 'https://data.geopf.fr/wms-r?LAYERS=SCANEM40_PYR_PNG_FXX_LAMB93&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'
                ],
                'tileSize': 256
            });

            map.addSource('carte-etat-major', {
                'type': 'raster',
                'tiles': [
                    'https://data.geopf.fr/wms-r?LAYERS=SCANEM40_PYR_PNG_FXX_LAMB93&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'
                ],
                'tileSize': 256
            });

            map.addLayer(
                {
                    'id': 'orthophotos-2023',
                    'source': 'orthophotos-2023',
                    'type': 'raster'
                },
                firstSymbolId
            );

            map.addLayer(
                {
                    'id': 'carte-etat-major',
                    'source': 'carte-etat-major',
                    'type': 'raster'
                },
                firstSymbolId
            );

            slider1.addEventListener('input', (e) => {
                map.setPaintProperty(
                    'carte-etat-major',
                    'raster-opacity',
                    parseInt(e.target.value, 10) / 100
                );
                // Value indicator
                sliderValue1.textContent = e.target.value + '%';
            });

            slider2.addEventListener('input', (e) => {
                map.setPaintProperty(
                    'orthophotos-2023',
                    'raster-opacity',
                    parseInt(e.target.value, 10) / 100
                );
                // Value indicator
                sliderValue2.textContent = e.target.value + '%';
            });
        }
        );

        map.addControl(new maplibregl.NavigationControl());

        map.addControl(new maplibregl.ScaleControl())

    </script>

</body>

</html>