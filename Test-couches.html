<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Atlas Historique du Limousin</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@4.7.0/dist/maplibre-gl.css" rel="stylesheet">

    <link rel="stylesheet" crossorigin href="/style.css">
    <link rel="icon" type="image/png" href="/static/img/favicon.ico">
</head>

<body>

    <div id="map"></div>

    <div class="map-overlay top">
        <div class="map-overlay-inner">
            <label for="carte-select">Carte principale</label>

            <!-- Il n'a pas moyen de savoir la date précise ?? -->
            <!-- Ajouter un bouton pour plus d'info? -->

            <select name="carte" id="carte-select-1">
                <option value="">--Choisissez une carte--</option>
                <option id="c1843" value="c1843">Carte de l'état-major (ca 1843)</option>
                <option id="c1950" value="c1950">Orthophotos de 1950-1965</option>
                <option id="c1965" value="c1965">Orthophotos de 1965-80</option>
                <option id="c2023" value="c2023">Orthophotos de 2013</option>
            </select>

            <label>Opacité de la carte principale: <span id="slider-value-1">100%</span></label>
            <input id="slider1" type="range" min="0" max="100" step="0" value="100">

            <label for="carte-select-2">Carte secondaire</label>

            <select name="carte" id="carte-select-2">
                <option value="">--Choisissez une carte--</option>
                <option id="c1843" value="c1843">Carte de l'état-major (ca 1843)</option>
                <option id="c1950" value="c1950">Orthophotos de 1950-1965</option>
                <option id="c1965" value="c1965">Orthophotos de 1965-80</option>
                <option id="c2023" value="c2023">Orthophotos de 2013</option>
            </select>

            <label>Opacité de la carte secondaire: <span id="slider-value-2">100%</span></label>
            <input id="slider2" type="range" min="0" max="100" step="0" value="100">
        </div>
    </div>

    <script>

        const map = new maplibregl.Map({
            container: 'map',
            // Choose from maplibre's core styles, or make your own style with maplibre Studio
            style:
                // 'https://data.geopf.fr/annexes/ressources/vectorTiles/styles/PLAN.IGN/standard.json',
                'https://api.maptiler.com/maps/streets/style.json?key=get_your_own_OpIi9ZULNHzrESv6T2vL',
            center: [1.25866, 45.83088],
            maxBounds: [[1.14858, 45.79313], [1.36808, 45.86836]],
            minZoom: 9.5,
            maxZoom: 20,
            zoom: 9.5
        });

        const slider1 = document.getElementById('slider1');
        const sliderValue1 = document.getElementById('slider-value-1');

        const slider2 = document.getElementById('slider2');
        const sliderValue2 = document.getElementById('slider-value-2');

        map.on('load', () => {

            // const layers = map.getStyle().layers;
            // // Find the index of the first symbol layer in the map style
            // let firstSymbolId;
            // for (let i = 0; i < layers.length; i++) {
            //     if (layers[i].type === 'symbol') {
            //         firstSymbolId = layers[i].id;
            //         break;
            //     }
            // }

            map.addSource("orthophotos2023", {
                "type": "raster",
                "tiles": [
                    "https://data.geopf.fr/wms-r?LAYERS=ORTHOIMAGERY.ORTHOPHOTOS.ORTHO-EXPRESS.2023&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256"
                ],
                "tileSize": 256,
                "attribution": "Institut national de l'information géographique et forestière"
            });

            map.addSource("orthophotos1950", {
                "type": "raster",
                "tiles": [
                    'https://data.geopf.fr/wms-r?LAYERS=ORTHOIMAGERY.ORTHOPHOTOS.1950-1965&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'
                ],
                "tileSize": 256,
                "attribution": "Institut national de l'information géographique et forestière"
            });

            map.addSource('carte1843', {
                'type': 'raster',
                'tiles': [
                    // layer1 Eliminar esta prueba?
                    'https://data.geopf.fr/wms-r?LAYERS=SCANEM40_PYR_PNG_FXX_LAMB93&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'
                ],
                'tileSize': 256,
                "attribution": "Institut national de l'information géographique et forestière"
            });

            map.addLayer(
                {
                    'id': 'carteSecondaire',
                    'source': 'orthophotos1950',
                    'type': 'raster'
                },
                // firstSymbolId
            );

            map.addLayer(
                {
                    'id': 'cartePrincipale',
                    'source': 'carte1843',
                    'type': 'raster'
                },
                // firstSymbolId
            );

            // Pour changer les sources des couches:

            // Nouvelle fonction

            function setLayerSource(layerId, source, sourceLayer) {
                const oldLayers = map.getStyle().layers;
                const layerIndex = oldLayers.findIndex(l => l.id === layerId);
                const layerDef = oldLayers[layerIndex];
                const before = oldLayers[layerIndex + 1] && oldLayers[layerIndex + 1].id;
                layerDef.source = source;
                if (sourceLayer) {
                    layerDef['source-layer'] = sourceLayer;
                }
                map.removeLayer(layerId);
                map.addLayer(layerDef, before);
            }

            // Carte Principale

            var cartes = document.getElementById('carte-select-1');

            cartes.addEventListener('change', function () {
                if (cartes.value == "c1843") {
                    setLayerSource(
                        'cartePrincipale', 'carte1843'
                    )
                }
                else if (cartes.value == "c1950") {
                    setLayerSource(
                        'cartePrincipale', 'orthophotos1950'
                    )
                }
                else if (cartes.value == "c2023") {
                    setLayerSource(
                        'cartePrincipale', 'orthophotos2023'
                    )
                }
            });

            // Carte secondaire

            var cartes2 = document.getElementById('carte-select-2');

            cartes2.addEventListener('change', function () {
                if (cartes2.value == "c1843") {
                    setLayerSource(
                        'carteSecondaire', 'carte1843'
                    )
                }
                else if (cartes2.value == "c1950") {
                    setLayerSource(
                        'carteSecondaire', 'orthophotos1950'
                    )
                }
                else if (cartes2.value == "c2023") {
                    setLayerSource(
                        'carteSecondaire', 'orthophotos2023'
                    )
                }
            });

            // Pour controler l'opacité:

            slider1.addEventListener('input', (e) => {
                map.setPaintProperty(
                    'cartePrincipale',
                    'raster-opacity',
                    parseInt(e.target.value, 10) / 100
                );
                // Value indicator
                sliderValue1.textContent = e.target.value + '%';
            });

            slider2.addEventListener('input', (e) => {
                map.setPaintProperty(
                    'carteSecondaire',
                    'raster-opacity',
                    parseInt(e.target.value, 10) / 100
                );
                // Value indicator
                sliderValue2.textContent = e.target.value + '%';
            });
        }
        );

        map.addControl(new maplibregl.NavigationControl());

        map.addControl(new maplibregl.ScaleControl())

        // Eliminar esta prueba?
        // var layer1 = 'https://data.geopf.fr/wms-r?LAYERS=SCANEM40_PYR_PNG_FXX_LAMB93&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'
        // var layer2 = 'https://data.geopf.fr/wms-r?LAYERS=ORTHOIMAGERY.ORTHOPHOTOS.ORTHO-EXPRESS.2023&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'

        // layer2 = 'https://data.geopf.fr/wms-r?LAYERS=ORTHOIMAGERY.ORTHOPHOTOS.1950-1965&FORMAT=image/jpeg&SERVICE=WMS&VERSION=1.3.0&REQUEST=GetMap&STYLES=&CRS=EPSG:3857&BBOX={bbox-epsg-3857}&WIDTH=256&HEIGHT=256'

    </script>

</body>

</html>